> 이 문서는 프로젝트의 상세 설계 및 구현 내용을 기록한 문서입니다.

# rotary-encoder-door-lock (다이얼 도어락)
### 지문 흔적 방지형 보안 도어락 시스템

## 수상

**2024 캡스톤디자인 장려상**

## 프로젝트 배경

### 문제 인식
**지문 기반 도어락의 치명적 보안 취약점**

1. **지문 도어락의 문제**
   - 도어락 표면에 남은 지문 흔적으로 비밀번호 유추 가능
   - 지문 채취를 통한 생체정보 도용 위험

2. **버튼식 도어락의 문제**
   - 자주 누르는 버튼에 지문/손때가 남음
   - 물리적 흔적을 통한 비밀번호 패턴 노출

3. **증가하는 주거 침입 범죄**
   - 1인 가구 급증 (2023년 전체 가구의 34.5%)
   - 주거 침입 사건 40% 증가 (2018-2022, 통계청)
   - 점점 정교해지는 도어락 해킹 수법

### 해결 방안
**물리적 흔적이 남지 않는 다이얼 방식 채택**

- 로터리 엔코더(조그셔틀) 사용 → 지문 흔적 남지 않음
- RFID 카드 인증 추가 → 편의성 확보

## 프로젝트 개요

| 구분 | 내용 |
|------|------|
| **팀명** | 안남조 |
| **제작 기간** | 2024년 3월 ~ 5월 30일 (3개월) |
| **팀 구성** | 6명 (팀장: 김동진) |
| **프로젝트 유형** | Standalone Embedded System |
| **핵심 차별화** | 지문 흔적이 남지 않는 다이얼 도어락 |

## 시스템 동작 흐름

```
1. 사용자 인증 시도
   ├─ 방법 A: 다이얼 회전 (비밀번호 4자리)
   └─ 방법 B: RFID 카드 태그

2. 입력 처리
   - 다이얼 좌/우 회전 → 숫자 증감
   - 다이얼 버튼 누름 → 숫자 확정
   - RFID UID 비교

3. 인증 결과 판단
   ├─ 성공: LCD 초록 표시 + 서보모터 구동
   └─ 실패: LCD 빨강 표시 + 재입력 대기

4. 자동 잠금
   - 3초 후 서보모터 원위치
```

## 주요 기능

### 1. 다이얼 인증 시스템
- **로터리 엔코더**: 4자리 비밀번호 입력
  - 우측 회전: 숫자 증가 (0→9)
  - 좌측 회전: 숫자 감소 (9→0)
  - 버튼 누름: 숫자 확정
- **채터링 방지**: 10ms 디바운싱 + 홀수/짝수 카운터

### 2. RFID 카드 인증
- **PN532 NFC 모듈** 사용
- 주기적 스캔 (1초 간격, 0.1초 동작)
- UID 비교 방식

### 3. 실시간 UI 피드백
- **4인치 LCD 터치스크린** (480×320)
- 입력 상태 시각화 (별표 마스킹)
- 성공/실패 컬러 피드백 (Green/Red)

### 4. 보안 기능
- **비밀번호 변경 모드**
  - 리셋 버튼 3초 누름
  - 새 비밀번호 재설정
- **자동 잠금**: 3초 후 자동 복귀

---

### 하드웨어

| 구분 | 부품명 | 역할 |
|------|--------|------|
| **MCU** | Arduino Uno R3 | 메인 제어기 |
| **입력** | 조그셔틀 엔코더 (5핀) | 다이얼 비밀번호 입력 |
| **인증** | PN532 NFC/RFID 모듈 | 카드 인식 |
| **출력** | SG90 서보모터 | 도어락 잠금장치 |
| **UI** | 4인치 LCD (480×320) | 상태 표시 |
| **리셋** | 택트 스위치 | 비밀번호 변경 |
| **전원** | 배터리 | 독립 동작 |
| **케이스** | 3D 프린팅 (PLA) | 외관 |

### 소프트웨어 아키텍처

```
Annam.ino (메인 제어)
├── 입력 처리
│   ├── handleEncoder()        # 다이얼 입력
│   ├── handlePasswordInput()  # 비밀번호 입력
│   ├── handleResetButton()    # 리셋 모드
│   └── handleRFID()           # RFID 스캔
│
├── 인증 로직
│   ├── checkPassword()        # 비밀번호 비교
│   └── compareUID()           # UID 비교
│
├── 출력 제어
│   ├── displayPasswordInput() # LCD UI
│   ├── setServo()             # 서보 PWM
│   └── handleCorrectPassword() # 잠금해제
│
└── LCD 라이브러리
    ├── lcd_4inch.*     # 하드웨어 제어
    ├── lcd_gui.*       # 그래픽 렌더링
    └── lcd_touch.*     # 터치 입력
```

## 팀원 역할

### 김동진 (팀장) - 소프트웨어 총괄
- 전체 일정 관리 및 작업 분배
- 시스템 설계 및 기능 기획
- **핵심 로직 구현**
  - 엔코더 입력 처리 (채터링 방지)
  - RFID 블로킹 문제 해결
  - 인증 흐름 및 상태 관리
  - LCD UI 렌더링
  - 서보모터 PWM 직접 구현

### 소프트웨어팀
- 김OO, 이OO: 코드 테스트 및 디버깅
- LCD-서보모터 충돌 문제 해결 지원

### 하드웨어팀
- 이OO, 고OO, 윤OO
- 3D 모델링 (onShape)
- 케이스 설계 및 3D 프린팅
- 부품 배치 및 조립

## 기술 스택

### 언어 & 플랫폼
- **C/C++** (Arduino Framework)

### 통신 프로토콜
- **SPI**: LCD, RFID 모듈

### 하드웨어 제어
- **GPIO**: 버튼, 엔코더 입력
- **PWM**: 서보모터 각도 제어 (직접 구현)
- **터치스크린**: 캘리브레이션

### 라이브러리
- **Adafruit_PN532**: RFID/NFC

## 기술적 도전 & 해결

### 1. Servo 라이브러리와 LCD 충돌 문제

**문제:**
```
Arduino Servo.h 사용 시 LCD SPI 통신 간섭 발생
→ 서보 제어 중 LCD 화면 깨짐
→ 동시 동작 불가능
```

**해결:**
```cpp
// Servo.h 사용 중단
// PWM 신호를 직접 구현

void setServo(int degree) {
    int hTime = minPulse + ((maxPulse - minPulse) / 180.0 * degree);
    int lTime = freq - hTime;
    
    for (int i = 0; i < 30; i++) {
        digitalWrite(SERVO_PIN, LOW);
        delayMicroseconds(lTime);
        digitalWrite(SERVO_PIN, HIGH);
        delayMicroseconds(hTime);
        digitalWrite(SERVO_PIN, LOW);
    }
}
```

**결과:**
- LCD와 서보모터 독립 동작 구현
- 안정적인 화면 출력 유지

### 2. 로터리 엔코더 채터링 문제

**문제:**
```
엔코더 회전 시 중복 인식 발생
→ 한 번 회전에 여러 번 카운트
→ 의도치 않은 숫자 변경
```

**해결:**
```cpp
// 홀수/짝수 카운터 로직
value = (counter / 2) % 10;

// 홀수일 때만 화면 업데이트
if (counter % 2 == 1) {
    Gui_draw_str(230, 150, num.c_str(), &Font24, BLACK, WHITE);
}

// 짝수일 때 딜레이 (디바운싱)
while (counter % 2 == 0) {
    delay(10);
    break;
}
```

**결과:**
- 정확한 입력 처리
- 사용자 경험 개선

### 3. RFID 블로킹 문제

**문제:**
```
RFID 카드 대기 중 전체 시스템 멈춤
→ 다이얼 입력 불가
→ 단일 스레드 환경의 한계
```

**시도했던 방법:**
```
멀티스레드 라이브러리 사용
   → Arduino 환경에서 불안정
```

**최종 해결:**
```cpp
// 주기적 스캔 방식 (논블로킹)
void handleRFID() {
    static unsigned long lastReadTime = 0;
    unsigned long currentTime = millis();
    
    // 1초 간격으로 체크
    if (currentTime - lastReadTime >= RFIDReadInterval) {
        lastReadTime = currentTime;
        
        // 0.1초 동안만 RFID 읽기
        unsigned long readStartTime = millis();
        while (millis() - readStartTime < RFIDReadDuration) {
            if (nfc.readPassiveTargetID(...)) {
                // 처리
                break;
            }
        }
    }
}
```

**결과:**
- 다이얼과 RFID 동시 사용 가능
- 시스템 응답성 유지

---

## 개발 과정

### 타임라인

| 주차 | 소프트웨어팀 | 하드웨어팀 |
|------|-------------|-----------|
| 1-2 | 기획 및 추진계획서 작성 | - |
| 3-4 | 부품 선정 | 부품 선정 |
| 5-6 | LCD + 엔코더 테스트 | 3D 모델링 학습 (onShape) |
| 7-8 | 채터링 문제 발견 | 다이얼 시제품 제작 |
| 9-10 | 서보모터 추가, 비밀번호 리셋 | 케이스 사이즈 설계 |
| 11-12 | 서보-LCD 충돌 해결 | 앞/뒷면 시험 제작 |
| 13 | RFID 블로킹 해결, 코드 모듈화 | 최종 케이스 제작 |
| 14 | 서보 각도 정밀화 | 하드웨어 최종 조립 |

## 3D 프린팅 제작 과정

### 설계 도구
- **onShape** (클라우드 CAD)

### 주요 고려사항
1. **정확한 수치 측정**
   - 아두이노 보드 크기
   - LCD 화면 크기
   - 부품 배치 간격

2. **내구성 확보**
   - 하중 지탱 부위 두께 강화
   - 서보모터 고정부 보강

3. **사용자 편의성**
   - 다이얼 최적 크기/두께
   - 회전 위치 접근성
   - 배터리 교체 용이성

4. **디테일**
   - 곡선 외관
   - 다이얼 손잡이
   - 내부 칸막이 (배선 정리)
   - 여닫이 구조 (유지보수)

---

## 한계점 & 개선 방향

### 현재 한계

| 문제점 | 영향 |
|--------|------|
| **서보모터 사용** | 보안성 의문 (외력으로 강제 회전 가능) |
| **절전 모드 부재** | LCD 상시 켜짐 → 전력 소모 ↑ |
| **청각 피드백 없음** | 사용자 인지 부족 |
| **네트워크 연동 없음** | 원격 제어/모니터링 불가 |
| **인증 정보 하드코딩** | 다중 사용자 관리 어려움 |
| **출입 이력 미저장** | 보안 감사 불가 |

### 향후 개선 방향

#### Phase 1: 하드웨어 개선
```
솔레노이드 도입 → 보안성 강화
부저 추가 → 사운드 피드백
절전 모드 → 전력 효율 ↑
```

#### Phase 2: 네트워크 연동
```
Wi-Fi 모듈 (ESP8266/ESP32)
클라우드 DB 연동 (Firebase/AWS)
사용자 관리 시스템
출입 로그 저장
```

#### Phase 3: 스마트홈 통합
```
MQTT 프로토콜
스마트폰 앱 연동
원격 잠금/해제
실시간 알림
```

## 기대 효과

### 사회적 기여
- **1인 가구 주거 안전 강화**
  - 지문 유출 위험 제로
  - 주거 침입 범죄 예방

### 기술적 의의
- **물리적 보안 강화**
  - 흔적 없는 인증 방식

### 사용자 가치
- **편의성**: RFID 빠른 인증
- **안심**: 생체정보 보호
- **직관성**: 다이얼 UI

## 성과

- **2024 캡스톤디자인 장려상** 수상
- 문제 해결 능력 향상
  - 채터링 → 디바운싱 로직
  - 라이브러리 충돌 → PWM 직접 구현
  - 블로킹 → 논블로킹 설계
- 팀 협업 경험
  - 소프트웨어/하드웨어 분업
  - 산업체 멘토링 활용

---

## 참고 자료

- [통계청 - 2023 통계로 보는 1인 가구](https://kostat.go.kr)
- [Adafruit PN532 라이브러리](https://github.com/adafruit/Adafruit-PN532)
- [Arduino PWM 제어](https://www.arduino.cc/reference/en/)

## 팀원

**안남조 (안전하게 남지 않는 조)**
- 김동진 (팀장, 소프트웨어 총괄)
- 김OO (소프트웨어)
- 이OO (소프트웨어)
- 이OO (하드웨어)
- 고OO (하드웨어)
- 윤OO (하드웨어)


**제작 기간**: 2024년 3월 ~ 5월 30일  
**프로젝트 지원**: 명지전문대학교 캡스톤디자인
